generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Team {
  id            String         @id @default(cuid())
  name          String         @unique
  apiKey        String         @unique @default(cuid())
  testCases     TestCase[]
  testRuns      TestRun[]
  retryRequests RetryRequest[]
  teamMembers   TeamMember[]
  createdAt     DateTime       @default(now())
}

model User {
  id             String          @id @default(cuid())
  email          String          @unique
  name           String
  password       String
  role           UserRole
  isActive       Boolean         @default(true)
  mustChangePass Boolean         @default(true)
  lastLoginAt    DateTime?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  teamMembers    TeamMember[]
  invitesSent    Invite[]        @relation("InviteSender")
  activityLogs   ActivityLog[]
  refreshTokens  RefreshToken[]
  passwordResets PasswordReset[]
}

model TeamMember {
  id       String   @id @default(cuid())
  userId   String
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  teamId   String
  team     Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  joinedAt DateTime @default(now())

  @@unique([userId, teamId])
  @@index([teamId])
  @@index([userId])
}

model RefreshToken {
  id         String   @id @default(cuid())
  token      String   @unique
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  deviceInfo String?

  @@index([userId])
  @@index([expiresAt])
}

model Invite {
  id          String       @id @default(cuid())
  email       String
  role        UserRole
  teamIds     String[]
  token       String       @unique @default(cuid())
  invitedById String
  invitedBy   User         @relation("InviteSender", fields: [invitedById], references: [id])
  status      InviteStatus @default(PENDING)
  expiresAt   DateTime
  createdAt   DateTime     @default(now())

  @@index([invitedById])
  @@index([status, expiresAt])
}

model PasswordReset {
  id        String    @id @default(cuid())
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String    @unique @default(cuid())
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  @@index([userId])
}

model ActivityLog {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  teamId    String?
  action    String
  details   String?
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([teamId])
  @@index([createdAt])
  @@index([action])
}

enum UserRole {
  ADMIN
  MANAGER
  SUPERVISOR
  TEAM_LEAD
  MEMBER
  MONITORING
}

enum InviteStatus {
  PENDING
  ACCEPTED
  EXPIRED
  CANCELLED
}

model TestCase {
  id            String         @id @default(cuid())
  title         String
  filePath      String
  suiteName     String?
  tags          String[]
  teamId        String
  team          Team           @relation(fields: [teamId], references: [id])
  results       TestResult[]
  retryRequests RetryRequest[]
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  @@unique([teamId, filePath, title])
  @@index([teamId])
  @@index([teamId, suiteName])
  @@index([suiteName])
  @@index([createdAt])
}

model TestRun {
  id          String       @id @default(cuid())
  teamId      String
  team        Team         @relation(fields: [teamId], references: [id])
  status      RunStatus    @default(RUNNING)
  results     TestResult[]
  totalTests  Int          @default(0)
  passed      Int          @default(0)
  failed      Int          @default(0)
  skipped     Int          @default(0)
  duration    Int?
  startedAt   DateTime     @default(now())
  finishedAt  DateTime?

  @@index([teamId])
  @@index([teamId, status])
  @@index([status])
  @@index([startedAt])
}

model TestResult {
  id         String     @id @default(cuid())
  testCaseId String
  testCase   TestCase   @relation(fields: [testCaseId], references: [id])
  testRunId  String
  testRun    TestRun    @relation(fields: [testRunId], references: [id])
  status     TestStatus
  duration   Int?
  error      String?
  retryCount Int        @default(0)
  artifacts  Artifact[]
  startedAt  DateTime   @default(now())
  finishedAt DateTime?

  @@index([testRunId])
  @@index([testCaseId])
  @@index([testRunId, status])
  @@index([status])
  @@index([startedAt])
}

model Artifact {
  id           String       @id @default(cuid())
  testResultId String
  testResult   TestResult   @relation(fields: [testResultId], references: [id])
  type         ArtifactType
  fileName     String
  fileUrl      String
  fileSize     Int?
  createdAt    DateTime     @default(now())

  @@index([testResultId])
}

enum RunStatus {
  RUNNING
  PASSED
  FAILED
  CANCELLED
}

enum TestStatus {
  PASSED
  FAILED
  SKIPPED
  RETRIED
}

enum ArtifactType {
  SCREENSHOT
  VIDEO
  TRACE
  LOG
}

model RetryRequest {
  id          String             @id @default(cuid())
  teamId      String
  team        Team               @relation(fields: [teamId], references: [id])
  testCaseId  String
  testCase    TestCase           @relation(fields: [testCaseId], references: [id])
  status      RetryRequestStatus @default(PENDING)
  requestedAt DateTime           @default(now())
  pickedUpAt  DateTime?
  completedAt DateTime?
  resultId    String?

  @@index([teamId])
  @@index([teamId, status])
  @@index([status])
  @@index([requestedAt])
}

enum RetryRequestStatus {
  PENDING
  RUNNING
  COMPLETED
  EXPIRED
}
