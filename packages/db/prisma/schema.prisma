generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Team {
  id            String              @id @default(cuid())
  name          String              @unique
  apiKey        String              @unique @default(cuid())
  testCases     TestCase[]
  testRuns      TestRun[]
  retryRequests RetryRequest[]
  teamMembers   TeamMember[]
  collections   LibraryCollection[]
  releases      Release[]
  applications  Application[]
  taskGroups    TaskGroup[]
  createdAt     DateTime            @default(now())
}

model User {
  id             String          @id @default(cuid())
  email          String          @unique
  name           String
  password       String
  role           UserRole
  isActive       Boolean         @default(true)
  mustChangePass Boolean         @default(true)
  lastLoginAt    DateTime?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  teamMembers              TeamMember[]
  invitesSent              Invite[]                 @relation("InviteSender")
  activityLogs             ActivityLog[]
  refreshTokens            RefreshToken[]
  passwordResets           PasswordReset[]
  collections              LibraryCollection[]      @relation("CollectionCreator")
  libraryTestCasesCreated  LibraryTestCase[]        @relation("LibraryTestCaseCreator")
  libraryTestCasesUpdated  LibraryTestCase[]        @relation("LibraryTestCaseUpdater")
  libraryVersions          LibraryTestCaseVersion[] @relation("LibraryVersionCreator")
  suggestions              LibrarySuggestion[]      @relation("SuggestionCreator")
  suggestionsReviewed      LibrarySuggestion[]      @relation("SuggestionReviewer")
  discussions              LibraryDiscussion[]      @relation("DiscussionCreator")
  bookmarks                LibraryBookmark[]
  releasesCreated          Release[]                @relation("ReleaseCreator")
  checklistAssignments     ReleaseChecklistItem[]   @relation("ChecklistAssignee")
  applicationsCreated      Application[]            @relation("ApplicationCreator")
  ownedTaskGroups          TaskGroup[]              @relation("TaskGroupOwner")
  createdTaskGroups        TaskGroup[]              @relation("TaskGroupCreator")
}

model TeamMember {
  id       String   @id @default(cuid())
  userId   String
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  teamId   String
  team     Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  joinedAt DateTime @default(now())

  @@unique([userId, teamId])
  @@index([teamId])
  @@index([userId])
}

model RefreshToken {
  id         String   @id @default(cuid())
  token      String   @unique
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  deviceInfo String?

  @@index([userId])
  @@index([expiresAt])
}

model Invite {
  id          String       @id @default(cuid())
  email       String
  role        UserRole
  teamIds     String[]
  token       String       @unique @default(cuid())
  invitedById String
  invitedBy   User         @relation("InviteSender", fields: [invitedById], references: [id])
  status      InviteStatus @default(PENDING)
  expiresAt   DateTime
  createdAt   DateTime     @default(now())

  @@index([invitedById])
  @@index([status, expiresAt])
}

model PasswordReset {
  id        String    @id @default(cuid())
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String    @unique @default(cuid())
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  @@index([userId])
}

model ActivityLog {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  teamId    String?
  action    String
  details   String?
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([teamId])
  @@index([createdAt])
  @@index([action])
}

enum UserRole {
  ADMIN
  MANAGER
  SUPERVISOR
  TEAM_LEAD
  MEMBER
  MONITORING
}

enum InviteStatus {
  PENDING
  ACCEPTED
  EXPIRED
  CANCELLED
}

model TestCase {
  id             String                 @id @default(cuid())
  title          String
  filePath       String
  suiteName      String?
  tags           String[]
  teamId         String
  team           Team                   @relation(fields: [teamId], references: [id])
  applicationId  String?
  application    Application?           @relation(fields: [applicationId], references: [id])
  results        TestResult[]
  retryRequests  RetryRequest[]
  libraryLinks   LibraryTestCaseLink[]
  checklistItems ReleaseChecklistItem[] @relation("ChecklistTestCase")
  createdAt      DateTime               @default(now())
  updatedAt      DateTime               @updatedAt

  @@unique([teamId, filePath, title])
  @@index([teamId])
  @@index([teamId, suiteName])
  @@index([suiteName])
  @@index([applicationId])
  @@index([createdAt])
}

model TestRun {
  id            String           @id @default(cuid())
  teamId        String
  team          Team             @relation(fields: [teamId], references: [id])
  applicationId String?
  application   Application?     @relation(fields: [applicationId], references: [id])
  status        RunStatus        @default(RUNNING)
  source        RunSource        @default(LOCAL)
  branch        String?          @db.VarChar(255)
  environment   String?          @db.VarChar(100)
  results       TestResult[]
  totalTests    Int              @default(0)
  passed        Int              @default(0)
  failed        Int              @default(0)
  skipped       Int              @default(0)
  duration      Int?
  startedAt     DateTime         @default(now())
  finishedAt    DateTime?
  releases          ReleaseTestRun[]
  taskItemsAsLocal  TaskGroupItem[]  @relation("TaskItemLocalRun")
  taskItemsAsEnv    TaskGroupItem[]  @relation("TaskItemEnvRun")

  @@index([teamId])
  @@index([teamId, status])
  @@index([status])
  @@index([startedAt])
  @@index([branch])
  @@index([source])
  @@index([environment])
  @@index([applicationId])
  @@index([teamId, source, branch])
}

model TestResult {
  id         String     @id @default(cuid())
  testCaseId String
  testCase   TestCase   @relation(fields: [testCaseId], references: [id])
  testRunId  String
  testRun    TestRun    @relation(fields: [testRunId], references: [id])
  status     TestStatus
  duration   Int?
  error      String?
  retryCount Int        @default(0)
  artifacts  Artifact[]
  startedAt  DateTime   @default(now())
  finishedAt DateTime?

  @@index([testRunId])
  @@index([testCaseId])
  @@index([testRunId, status])
  @@index([status])
  @@index([startedAt])
}

model Artifact {
  id           String       @id @default(cuid())
  testResultId String
  testResult   TestResult   @relation(fields: [testResultId], references: [id])
  type         ArtifactType
  fileName     String
  fileUrl      String
  fileSize     Int?
  createdAt    DateTime     @default(now())

  @@index([testResultId])
}

enum RunStatus {
  RUNNING
  PASSED
  FAILED
  CANCELLED
}

enum RunSource {
  LOCAL
  CI
  MANUAL
}

enum TestStatus {
  PASSED
  FAILED
  SKIPPED
  RETRIED
}

enum ArtifactType {
  SCREENSHOT
  VIDEO
  TRACE
  LOG
}

model RetryRequest {
  id          String             @id @default(cuid())
  teamId      String
  team        Team               @relation(fields: [teamId], references: [id])
  testCaseId  String
  testCase    TestCase           @relation(fields: [testCaseId], references: [id])
  status      RetryRequestStatus @default(PENDING)
  requestedAt DateTime           @default(now())
  pickedUpAt  DateTime?
  completedAt DateTime?
  resultId    String?

  @@index([teamId])
  @@index([teamId, status])
  @@index([status])
  @@index([requestedAt])
}

enum RetryRequestStatus {
  PENDING
  RUNNING
  COMPLETED
  EXPIRED
}

// ── Library enums ──────────────────────────────────────────────────────────────

enum TestPriority {
  P0
  P1
  P2
  P3
}

enum TestDifficulty {
  EASY
  MEDIUM
  HARD
  COMPLEX
}

enum LibraryTestCaseStatus {
  DRAFT
  ACTIVE
  DEPRECATED
  ARCHIVED
}

enum SuggestionType {
  IMPROVEMENT
  BUG_REPORT
  UPDATE
  OBSOLETE
}

enum SuggestionStatus {
  PENDING
  ACCEPTED
  REJECTED
}

// ── Release enums ─────────────────────────────────────────────────────────────

enum ReleaseStatus {
  DRAFT
  IN_PROGRESS
  BLOCKED
  RELEASED
  CANCELLED
}

enum ChecklistItemType {
  MANUAL_TEST
  AUTOMATED_TEST
  DEPLOYMENT
  VERIFICATION
  SIGN_OFF
}

enum ChecklistItemStatus {
  PENDING
  IN_PROGRESS
  PASSED
  FAILED
  BLOCKED
  SKIPPED
}

// ── Library models ─────────────────────────────────────────────────────────────

model LibraryCollection {
  id            String            @id @default(cuid())
  name          String
  description   String?
  icon          String?
  teamId        String?
  team          Team?             @relation(fields: [teamId], references: [id])
  applicationId String?
  application   Application?      @relation(fields: [applicationId], references: [id])
  createdById   String
  createdBy     User              @relation("CollectionCreator", fields: [createdById], references: [id])
  testCases     LibraryTestCase[]
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  @@index([teamId])
  @@index([applicationId])
  @@index([createdById])
}

model LibraryTestCase {
  id              String                   @id @default(cuid())
  title           String
  description     String?
  priority        TestPriority             @default(P2)
  difficulty      TestDifficulty           @default(MEDIUM)
  status          LibraryTestCaseStatus    @default(DRAFT)
  collectionId    String?
  collection      LibraryCollection?       @relation(fields: [collectionId], references: [id])
  tags            String[]
  steps           String?
  preconditions   String?
  expectedOutcome String?
  createdById     String
  createdBy       User                     @relation("LibraryTestCaseCreator", fields: [createdById], references: [id])
  updatedById     String?
  updatedBy       User?                    @relation("LibraryTestCaseUpdater", fields: [updatedById], references: [id])
  versions        LibraryTestCaseVersion[]
  dependencies    LibraryDependency[]      @relation("DependencySource")
  dependents      LibraryDependency[]      @relation("DependencyTarget")
  suggestions     LibrarySuggestion[]
  discussions     LibraryDiscussion[]
  bookmarks       LibraryBookmark[]
  linkedTestCases LibraryTestCaseLink[]
  checklistItems  ReleaseChecklistItem[]   @relation("ChecklistLibraryTestCase")
  taskGroupItems  TaskGroupItem[]
  createdAt       DateTime                 @default(now())
  updatedAt       DateTime                 @updatedAt

  @@index([collectionId])
  @@index([status])
  @@index([priority])
  @@index([createdById])
}

model LibraryTestCaseVersion {
  id                String          @id @default(cuid())
  libraryTestCaseId String
  libraryTestCase   LibraryTestCase @relation(fields: [libraryTestCaseId], references: [id], onDelete: Cascade)
  version           Int
  title             String
  description       String?
  steps             String?
  preconditions     String?
  expectedOutcome   String?
  changeNotes       String?
  createdById       String
  createdBy         User            @relation("LibraryVersionCreator", fields: [createdById], references: [id])
  createdAt         DateTime        @default(now())

  @@unique([libraryTestCaseId, version])
  @@index([libraryTestCaseId])
}

model LibraryDependency {
  id                String          @id @default(cuid())
  libraryTestCaseId String
  libraryTestCase   LibraryTestCase @relation("DependencySource", fields: [libraryTestCaseId], references: [id], onDelete: Cascade)
  dependsOnId       String
  dependsOn         LibraryTestCase @relation("DependencyTarget", fields: [dependsOnId], references: [id], onDelete: Cascade)
  createdAt         DateTime        @default(now())

  @@unique([libraryTestCaseId, dependsOnId])
  @@index([libraryTestCaseId])
  @@index([dependsOnId])
}

model LibrarySuggestion {
  id                String           @id @default(cuid())
  libraryTestCaseId String
  libraryTestCase   LibraryTestCase  @relation(fields: [libraryTestCaseId], references: [id], onDelete: Cascade)
  type              SuggestionType
  content           String
  status            SuggestionStatus @default(PENDING)
  createdById       String
  createdBy         User             @relation("SuggestionCreator", fields: [createdById], references: [id])
  reviewedById      String?
  reviewedBy        User?            @relation("SuggestionReviewer", fields: [reviewedById], references: [id])
  reviewedAt        DateTime?
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  @@index([libraryTestCaseId])
  @@index([createdById])
  @@index([status])
}

model LibraryDiscussion {
  id                String          @id @default(cuid())
  libraryTestCaseId String
  libraryTestCase   LibraryTestCase @relation(fields: [libraryTestCaseId], references: [id], onDelete: Cascade)
  content           String
  createdById       String
  createdBy         User            @relation("DiscussionCreator", fields: [createdById], references: [id])
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  @@index([libraryTestCaseId])
  @@index([createdById])
}

model LibraryBookmark {
  id                String          @id @default(cuid())
  libraryTestCaseId String
  libraryTestCase   LibraryTestCase @relation(fields: [libraryTestCaseId], references: [id], onDelete: Cascade)
  userId            String
  user              User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt         DateTime        @default(now())

  @@unique([libraryTestCaseId, userId])
  @@index([userId])
  @@index([libraryTestCaseId])
}

model LibraryTestCaseLink {
  id                String          @id @default(cuid())
  libraryTestCaseId String
  libraryTestCase   LibraryTestCase @relation(fields: [libraryTestCaseId], references: [id], onDelete: Cascade)
  testCaseId        String
  testCase          TestCase        @relation(fields: [testCaseId], references: [id], onDelete: Cascade)
  autoMatched       Boolean         @default(false)
  createdAt         DateTime        @default(now())

  @@unique([libraryTestCaseId, testCaseId])
  @@index([libraryTestCaseId])
  @@index([testCaseId])
}

// ── Release models ────────────────────────────────────────────────────────────

model Release {
  id             String                 @id @default(cuid())
  name           String
  version        String
  description    String?
  status         ReleaseStatus          @default(DRAFT)
  teamId         String?
  team           Team?                  @relation(fields: [teamId], references: [id])
  applicationId  String?
  application    Application?           @relation(fields: [applicationId], references: [id])
  targetDate     DateTime?
  releasedAt     DateTime?
  createdById    String
  createdBy      User                   @relation("ReleaseCreator", fields: [createdById], references: [id])
  checklistItems ReleaseChecklistItem[]
  testRuns       ReleaseTestRun[]
  createdAt      DateTime               @default(now())
  updatedAt      DateTime               @updatedAt

  @@index([teamId])
  @@index([applicationId])
  @@index([status])
  @@index([createdById])
  @@index([createdAt])
}

model ReleaseTestRun {
  id        String   @id @default(cuid())
  releaseId String
  release   Release  @relation(fields: [releaseId], references: [id], onDelete: Cascade)
  testRunId String
  testRun   TestRun  @relation(fields: [testRunId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([releaseId, testRunId])
  @@index([releaseId])
  @@index([testRunId])
}

model ReleaseChecklistItem {
  id                String              @id @default(cuid())
  releaseId         String
  release           Release             @relation(fields: [releaseId], references: [id], onDelete: Cascade)
  type              ChecklistItemType
  title             String
  description       String?
  status            ChecklistItemStatus @default(PENDING)
  libraryTestCaseId String?
  libraryTestCase   LibraryTestCase?    @relation("ChecklistLibraryTestCase", fields: [libraryTestCaseId], references: [id])
  testCaseId        String?
  testCase          TestCase?           @relation("ChecklistTestCase", fields: [testCaseId], references: [id])
  order             Int                 @default(0)
  assignedToId      String?
  assignedTo        User?               @relation("ChecklistAssignee", fields: [assignedToId], references: [id])
  completedAt       DateTime?
  notes             String?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt

  @@index([releaseId])
  @@index([status])
  @@index([libraryTestCaseId])
  @@index([testCaseId])
}

// ── Task Group enums ──────────────────────────────────────────────────────────

enum TaskGroupStatus {
  ACTIVE
  COMPLETED
  ARCHIVED
}

enum TaskItemPersonalStatus {
  NOT_STARTED
  IN_PROGRESS
  SKIPPED
}

// ── Task Group models ─────────────────────────────────────────────────────────

model TaskGroup {
  id            String          @id @default(cuid())
  name          String          @db.VarChar(200)

  userId        String
  user          User            @relation("TaskGroupOwner", fields: [userId], references: [id])

  createdById   String
  createdBy     User            @relation("TaskGroupCreator", fields: [createdById], references: [id])

  teamId        String
  team          Team            @relation(fields: [teamId], references: [id], onDelete: Cascade)

  applicationId String?
  application   Application?    @relation(fields: [applicationId], references: [id])

  branch        String?         @db.VarChar(255)
  dueDate       DateTime?
  status        TaskGroupStatus @default(ACTIVE)

  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  items         TaskGroupItem[]

  @@index([userId])
  @@index([userId, status])
  @@index([teamId])
  @@index([teamId, status])
  @@index([branch])
  @@index([applicationId])
}

model TaskGroupItem {
  id              String                 @id @default(cuid())

  taskGroupId     String
  taskGroup       TaskGroup              @relation(fields: [taskGroupId], references: [id], onDelete: Cascade)

  libraryTestCaseId String
  libraryTestCase   LibraryTestCase      @relation(fields: [libraryTestCaseId], references: [id])

  personalStatus  TaskItemPersonalStatus @default(NOT_STARTED)
  skippedReason   String?                @db.Text

  localResultStatus String?              @db.VarChar(20)
  localTestRunId    String?
  localTestRun      TestRun?             @relation("TaskItemLocalRun", fields: [localTestRunId], references: [id])
  localMatchedAt    DateTime?

  envResultStatus   String?              @db.VarChar(20)
  envTestRunId      String?
  envTestRun        TestRun?             @relation("TaskItemEnvRun", fields: [envTestRunId], references: [id])
  envMatchedAt      DateTime?

  note            String?                @db.Text
  order           Int                    @default(0)

  createdAt       DateTime               @default(now())
  updatedAt       DateTime               @updatedAt

  @@unique([taskGroupId, libraryTestCaseId])
  @@index([taskGroupId])
  @@index([libraryTestCaseId])
  @@index([localTestRunId])
  @@index([envTestRunId])
}

// ── Application model ─────────────────────────────────────────────────────────

model Application {
  id           String              @id @default(cuid())
  name         String
  slug         String
  description  String?
  icon         String?
  color        String?
  environments String[]
  isActive     Boolean             @default(true)
  teamId       String
  team         Team                @relation(fields: [teamId], references: [id], onDelete: Cascade)
  createdById  String
  createdBy    User                @relation("ApplicationCreator", fields: [createdById], references: [id])
  testRuns     TestRun[]
  testCases    TestCase[]
  collections  LibraryCollection[]
  releases     Release[]
  taskGroups   TaskGroup[]
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt

  @@unique([teamId, slug])
  @@index([teamId])
  @@index([slug])
  @@index([isActive])
}
